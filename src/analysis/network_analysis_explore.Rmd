---
title: "Analysis"
author: "Ashish"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: paper
---
# Initialization
```{r, message=FALSE}
rm(list=ls())
library(lmerTest)
library(igraph)
library(here)
library(tidyverse)
theme_set(theme_bw())
```

```{r, eval=FALSE}
library(tidylog)
```


# Preprocessing

## Functions
```{r}
scale_numerics <- function(df, new_cols=TRUE, ...){
  if(new_cols){df %>% mutate_if(is.numeric, list(sc = ~rsurveyutils::scale(., ...)))}
  else {df %>% mutate_if(is.numeric,  ~scale(., ...))}
}
recent_date_dir <- function(directory, recursive=FALSE){
  files <- list.files(directory, 
                      pattern="[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}$",
                      include.dirs=TRUE,
                      recursive=recursive)
  files <- sort(as.Date(files), decreasing = TRUE)
  return(files[1])
}
```

## Read data
```{r, message=FALSE}
filepath <- paste0("data/raw/", recent_date_dir("data/raw"), "/emotion-similarity-task.csv")
print(paste("Datafile:", filepath))
df_raw <- read_csv(here(filepath))
```

## Process data
```{r, message=FALSE}
df_proc <- df_raw %>% 
  filter(pool == "rep" | pool == "psychone") %>% 
  filter(nchar(pid) >= 4) %>% 
  # -- remove columns with all NA -- #
  select_if(~!all(is.na(.))) %>% 
  # -- keep only trials -- #
  # filter(trial_type == "image-multi-select") %>% 
  # filter(!str_detect(stimuli, "practice_images")) %>% 
  # -- reformat file name strings -- #
  mutate(stimuli = str_replace_all(stimuli, '\\[|\\]|\\"', '')) %>% 
  mutate_at(vars(images_chosen, stimuli), ~str_replace_all(., "/", "_")) %>% 
  mutate_at(vars(stimuli, images_chosen), ~str_replace_all(., "Stimuli_", "")) %>% 
  # -- get file names in separate columns -- #
  separate(stimuli, c("img_file_1", "img_file_2", "img_file_3"), sep=",") %>% 
  mutate(
    trial_valence = str_extract(img_file_1, "negative|positive|neutral")
  ) %>% 
  # mutate(
  #   img_valence_1 = str_extract(img_file_1, "negative|positive|neutral"),
  #   img_valence_2 = str_extract(img_file_2, "negative|positive|neutral"),
  #   img_valence_3 = str_extract(img_file_3, "negative|positive|neutral"),
  # ) %>% 
  # -- get chosen and not chosen file names -- #
  mutate(imgs_filesChosen = str_replace_all(images_chosen, '\\[|\\]|\\"', '')) %>% 
  select(-images_chosen) %>% 
  separate(imgs_filesChosen, c("img_file_chosen_1", "img_file_chosen_2"), sep=",") %>% 
  mutate(img_file_notChosen = case_when(
    img_file_1 != img_file_chosen_1 & img_file_1 != img_file_chosen_2 ~ img_file_1,
    img_file_2 != img_file_chosen_1 & img_file_2 != img_file_chosen_2 ~ img_file_2,
    img_file_3 != img_file_chosen_1 & img_file_3 != img_file_chosen_2 ~ img_file_3
  )) %>%
  
  # -- get chosen and not chosen file numbers -- #
  mutate(img_num_chosen_1 = case_when(
    img_file_chosen_1 == img_file_1 ~ 1,
    img_file_chosen_1 == img_file_2 ~ 2,
    img_file_chosen_1 == img_file_3 ~ 3
  )) %>% 
  mutate(img_num_chosen_2 = case_when(
    img_file_chosen_2 == img_file_1 ~ 1,
    img_file_chosen_2 == img_file_2 ~ 2,
    img_file_chosen_2 == img_file_3 ~ 3
  )) %>% 
  mutate(img_num_notChosen = case_when(
    img_file_1 != img_file_chosen_1 & img_file_1 != img_file_chosen_2 ~ 1,
    img_file_2 != img_file_chosen_1 & img_file_2 != img_file_chosen_2 ~ 2,
    img_file_3 != img_file_chosen_1 & img_file_3 != img_file_chosen_2 ~ 3
  )) %>% 
  # -- attention checks -- #
  # ac free response
  mutate(ac_freeResp = ifelse(str_detect(responses, "ac_1"), responses, "")) %>% 
  mutate(ac_freeResp = str_replace_all(ac_freeResp, '[\\{\\}\\"]', "")) %>% 
  mutate(ac_freeResp = str_replace_all(ac_freeResp, "ac_1:", "")) %>% 
  mutate(trial_valence = ifelse(ac_freeResp != "", lag(trial_valence), trial_valence)) %>% 
  # ac forced choice
  mutate(ac_forceChoice_file =  ifelse(str_detect(responses, "ac_2"), responses, "")) %>% 
  mutate(ac_forceChoice_file = str_replace_all(ac_forceChoice_file, 
                                               '[\\{\\}\\"]', 
                                               "")) %>% 
  mutate(ac_forceChoice_file = str_replace_all(ac_forceChoice_file, 
                                               "ac_2:.*img src =", 
                                               "")) %>% 
  mutate(ac_forceChoice_file = str_replace_all(ac_forceChoice_file, 
                                               " width=266.66 height=200>",
                                               "")) %>%
  mutate(ac_forceChoice_file = str_replace_all(ac_forceChoice_file,
                                               "/", 
                                               "_")) %>% 
  mutate(ac_forceChoice_file = str_replace_all(ac_forceChoice_file, 
                                               "Stimuli_",
                                               "")) %>% 
  mutate(ac_forceChoice = ifelse(lag(img_file_notChosen) == ac_forceChoice_file, 1, 0)) %>% 
  mutate(ac_forceChoice = ifelse(ac_forceChoice_file == "", NA, ac_forceChoice)) 

```

# forced choice attention check
```{r}
df_ac_fc <- df_proc %>% 
  drop_na(ac_forceChoice) %>% 
  group_by(pid, pool) %>% 
  summarize(pr_correct = mean(ac_forceChoice)) %>% 
  ungroup
df_ac_fc %>% 
  ggplot(aes(x = pr_correct)) + 
  geom_histogram()
ac_fail_pids <- df_ac_fc %>% 
  filter(pr_correct < .33) %>% # .33 = 4 correct out of 12, 15% chance if guessing
  pull(pid)

# df_ac_fc %>% 
#   filter(pool == "rep" & pr_correct < .33)
  
```

```{r}
df_trials <- df_proc %>% 
  # -- keep only trials -- #
  filter(trial_type == "image-multi-select") %>%
  filter(!str_detect(img_file_1, "practice_images")) %>%
  # -- remove AC fails -- #
  filter(!pid %in% ac_fail_pids) %>% 
  # -- preproc -- #
  select(pid, trial_index, trial_valence,
         img_file_chosen_1, img_file_chosen_2,
         img_file_1, img_file_2, img_file_3) %>% 
  pivot_longer(c(img_file_1, img_file_2, img_file_3), 
               values_to="img_file", names_to="label") %>% 
  mutate(is_chosen=ifelse(img_file == img_file_chosen_1 | 
                            img_file == img_file_chosen_2, 
                          1, 0)) %>% 
  select(-c(img_file_chosen_1, img_file_chosen_2)) %>% 
  arrange(pid, trial_index, img_file)

df_trials_wide <- df_trials %>% 
  arrange(pid, trial_index, desc(is_chosen), img_file) %>% 
  select(-label) %>% 
  group_by(pid, trial_index) %>% 
  mutate(img_num = 1:n()) %>% 
  ungroup %>% 
  pivot_wider(id_cols = c(pid, trial_index, trial_valence), names_from = img_num, values_from=c(img_file, is_chosen))
```



```{r, echo=FALSE}
# ------ End Preprocessing ------ #
# ----- Run all chunks above -----#
```

# number of participants
```{r}
df_proc %>% 
  group_by(pid) %>% 
  summarise(n = n())

df_proc %>% pull(pid) %>% unique
```

# response time distribution
```{r}
# participant mean response time
df_proc %>% 
  mutate(rt = as.numeric(rt)/1000) %>% 
  filter(rsurveyutils::scale(rt) < 3) %>% # remove if 3 SDs above mean
  group_by(pid) %>% 
  summarize(mean_rt = mean(rt)) %>% 
  ggplot(aes(x = mean_rt)) + 
  geom_histogram()

# df_proc %>% 
#   filter(pid == "96301") %>% 
#   mutate(rt = as.numeric(rt)) %>% 
#   filter(rsurveyutils::scale(rt) < 3) %>% # remove if 3 SDs above mean
#   group_by(pid) %>% 
#   summarize(mean_rt = mean(rt)) %>% 
#   ggplot(aes(x = mean_rt)) + 
#   geom_histogram()

# trial response time
df_proc %>% 
  mutate(rt = as.numeric(rt)/1000) %>% 
  filter(rsurveyutils::scale(rt) < 3) %>% # remove if 3 SDs above mean
  ggplot(aes(x = rt)) + 
  geom_histogram()

```

# total time spent on survey
```{r}
df_proc %>% 
  group_by(run_id) %>% 
  filter(time_elapsed == max(time_elapsed)) %>% 
  ungroup %>% 
  mutate(mins_elapsed = as.numeric(time_elapsed)/(1000*60)) %>% 
  ggplot(aes(x = mins_elapsed)) + 
  geom_histogram()

# df_proc %>% 
#   filter(pid == "96301") %>% 
#   filter(time_elapsed == max(time_elapsed)) %>% 
#   ungroup %>% 
#   mutate(mins_elapsed = as.numeric(time_elapsed)/(1000*60)) %>% 
#   ggplot(aes(x = mins_elapsed)) + 
#   geom_histogram()

```



# graph community structure and fit clustering
```{r}
get_graph <- function(df){
   df %>%
    select(img_file_1, img_file_2) %>% 
    graph_from_data_frame(directed=FALSE) 
}

df_graphs <- df_trials_wide %>% 
  group_by(pid, trial_valence) %>% 
  nest() %>%
  mutate(graph = map(data, get_graph)) %>% 
  mutate(cluster = map(graph, cluster_walktrap)) %>% 
  mutate(modularity = map_dbl(cluster, modularity)) %>% 
  # mutate(cluster_plot = map2(cluster, graph, ~plot(.x, .y))) %>% 
  mutate(n_clusters = map_dbl(cluster, ~length(unique(.$membership))))
```

# plot all participant clusters
```{r eval=FALSE}
clusterPlots_dir <- here(paste0("results/", Sys.Date(), "/clusterPlots"))
dir.create(clusterPlots_dir, recursive=TRUE)
pdf(paste0(clusterPlots_dir, "/pid_valence_clusterPlots.pdf"))
for(i in 1:nrow(df_graphs)){
  # plot of clusters
  plot(df_graphs$cluster[[i]], 
       df_graphs$graph[[i]],
       main=paste(df_graphs$pid[i], df_graphs$trial_valence[i]))
  # get free response dimensions of clustering
  freeResp <- df_proc %>% 
    filter(pid == df_graphs$pid[[i]]) %>% 
    filter(ac_freeResp != "") %>% 
    filter(trial_valence == df_graphs$trial_valence[[i]]) %>% 
    pull(ac_freeResp)
  if(length(freeResp) > 0){
    text(0,-1.4, labels=paste(freeResp, collapse = "\n"))
  }
  # get attention check score
  pr_correct <- df_ac_fc %>% 
    filter(pid == df_graphs$pid[[i]]) %>% 
    pull(pr_correct)
  text(-1.2,1.3, labels=paste("AC correct pr:", round(pr_correct, 2)))
}
dev.off()
```

# Modularity by trial valence
```{r}
df_graphs %>% 
  ggplot(aes(y = modularity, x = trial_valence)) + 
  # geom_point(alpha = .3, position=position_jitter(.1)) +
  stat_summary(fun.data = "mean_cl_boot") 

df_graphs %>% 
  lmer(modularity ~ (1|pid), .) %>% 
  summary
df_graphs %>% 
  lmer(modularity ~ trial_valence + (1|pid), .) %>% 
  summary
```

# Clusters by trial valence
```{r}
df_graphs %>% 
  ggplot(aes(y = n_clusters, x = trial_valence)) + 
  # geom_point(alpha = .3, position=position_jitter(.1)) + 
  stat_summary(fun.data = "mean_cl_boot") 

df_graphs %>% 
  lmer(n_clusters ~ (1|pid), .) %>% 
  summary
df_graphs %>% 
  lmer(n_clusters ~ trial_valence + (1|pid), .) %>% 
  summary

```


# explanations of why they chose what they did
```{r}
df_proc
```


# Session Info
```{r}
sessionInfo()
```

